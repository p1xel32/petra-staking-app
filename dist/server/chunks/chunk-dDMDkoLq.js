import{jsxs as t,jsx as e,Fragment as Y}from"react/jsx-runtime";import{useState as r,useRef as X,useCallback as be,useEffect as ve}from"react";import{Aptos as Ne,Network as ye}from"@aptos-labs/ts-sdk";import{Activity as Pe,AlertCircle as Re,Info as oe,Loader2 as ke,RefreshCw as we,Landmark as Ce,Layers as Se,Percent as _e,TrendingUp as De,Clock as Ee,CheckSquare as Te,Hourglass as Ie,Package as Fe,ExternalLink as Le}from"lucide-react";/*! src/components/ValidatorInfo.jsx [vike:pluginModuleBanner] */const Ue="https://rpc.mainnet.aptos.network/v1",R=new Ne({network:ye.MAINNET,clientConfig:{NODE_URL:Ue}}),k="0xf747e3a6282cc0dee1c89239c529b039c64fe48e88b50e5cedd40e9c094800bb",Z="0x1",ee="0x1::staking_config::StakingConfig",te="0x1::block::BlockResource",w=1e8,$e=5*60;function Oe(s){if(s<=0)return"Unlocked";const a=Math.floor(s/(3600*24)),o=Math.floor(s%(3600*24)/3600),h=Math.floor(s%3600/60);let n=[];return a>0&&n.push(`${a}d`),o>0&&n.push(`${o}h`),(h>0||a===0&&o===0)&&n.push(`${h}m`),n.length>0?`in ${n.join(" ")}`:"Soon"}const f=({icon:s,label:a,value:o,valueClasses:h="text-gray-100 font-semibold",link:n=null,subValue:y=null,iconColor:P="text-purple-400",tooltipContent:v=null})=>t("div",{className:"flex justify-between items-center py-2.5 border-b border-gray-700/60 last:border-b-0",children:[t("span",{className:"text-gray-400 flex items-center text-sm",children:[s&&e(s,{size:16,className:`mr-2 ${P}`}),a,":"]}),n?t("a",{href:n,target:"_blank",rel:"noopener noreferrer",className:`font-mono text-sm break-all text-right ${h} hover:text-purple-300 transition-colors duration-150 flex items-center gap-1`,children:[o,e(Le,{size:12})]}):t("div",{className:"flex items-center justify-end text-right",children:[e("span",{className:`text-sm ${h}`,children:o}),v&&t("span",{className:"ml-1.5 group relative cursor-help",children:[e(oe,{size:14,className:"text-gray-500 group-hover:text-gray-300"}),e("div",{className:`absolute bottom-full right-0 transform translate-y-0 mb-2 w-64 p-3 text-xs text-left
                          bg-gray-800 border border-gray-700 text-gray-300 rounded-md shadow-lg
                          opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10`,children:v})]}),y&&!v&&e("p",{className:"text-xs text-zinc-400 ml-1",children:y})]})]});function je({account:s,refreshTrigger:a}){const[o,h]=r(null),[n,y]=r(null),[P,v]=r(null),[z,se]=r(null),[C,re]=r(null),[ne,S]=r(0),[ae,_]=r(0),[le,D]=r(0),[x,ie]=r(null),[E,T]=r(!0),[I,B]=r(!1),[M,G]=r(null),d=X({poolResources:null,poolCalculations:null,fetchTimestamp:0}),V=X(a),F=be(async(A=!1)=>{A?B(!0):T(!0),G(null);const q=Math.floor(Date.now()/1e3);let K=!1;try{let i,u,c,b,m,p,N;if(!A&&d.current.poolResources&&d.current.poolCalculations&&q-d.current.fetchTimestamp<$e)console.log("Using cached pool data"),{delegationResData:i,poolResData:u,stakingConfigResData:c,blockInfoResData:b}=d.current.poolResources,{calculatedGrossAprNum:m,calculatedGrossApyNum:p,commissionRateValue:N}=d.current.poolCalculations,K=!0;else{console.log(A?"Force fetching fresh pool data":"Fetching fresh pool data (cache miss or stale)");const g=[R.getAccountResources({accountAddress:k}),R.getAccountResource({accountAddress:Z,resourceType:ee}),R.getAccountResource({accountAddress:Z,resourceType:te})],L=await Promise.all(g),W=L[0];c=L[1],b=L[2];const U=W.find(l=>l.type.startsWith("0x1::delegation_pool::DelegationPool")),$=W.find(l=>l.type==="0x1::stake::StakePool");if(!U||!$||!c||!b){let l=[];throw U||l.push("DelegationPool"),$||l.push("StakePool"),c||l.push(ee),b||l.push(te),new Error(`Required Aptos resources not found: ${l.join(", ")}.`)}if(i=U.data,u=$.data,!u||u.active===void 0||u.active.value===void 0)throw new Error("Stake pool data or its 'active.value' field is missing.");if(!i)throw new Error("Delegation pool data is missing.");if(c.rewards_rate===void 0||c.rewards_rate_denominator===void 0||b.epoch_interval===void 0)throw new Error("Could not find required fields for APR/APY calculation.");d.current.poolResources={delegationResData:i,poolResData:u,stakingConfigResData:c,blockInfoResData:b},N=Number(i.operator_commission_percentage)/1e4;const Ae=BigInt(c.rewards_rate),H=BigInt(c.rewards_rate_denominator),J=BigInt(b.epoch_interval);if(m=null,p=null,H!==0n&&J!==0n){const Q=31536e3/Number(J/1000000n),O=Number(Ae)/Number(H);m=O*Q*100,O>=0&&(p=(Math.pow(1+O,Q)-1)*100)}else console.warn("Cannot calculate Aptos APR/APY due to zero denominator or epoch interval.");d.current.poolCalculations={calculatedGrossAprNum:m,calculatedGrossApyNum:p,commissionRateValue:N},d.current.fetchTimestamp=q}const ge=BigInt(u.active.value),fe=Number(ge)/w,he=Number(i.operator_commission_percentage)/100,xe=Number(u.locked_until_secs);if(h({poolAddress:k,delegated:fe,commission:he}),y(m!==null?m.toFixed(2):null),v(m!==null?(m*(1-N)).toFixed(2):null),se(p!==null?p.toFixed(2):null),re(p!==null?(p*(1-N)).toFixed(2):null),ie(xe),s){K&&!A&&T(!0);const g=await R.view({payload:{function:"0x1::delegation_pool::get_stake",functionArguments:[k,s]}});Array.isArray(g)&&g.length>=3?(S(Number(BigInt(g[0]))/w),_(Number(BigInt(g[1]))/w),D(Number(BigInt(g[2]))/w)):(console.warn("Unexpected user stake result format from Aptos blockchain.",g),S(0),_(0),D(0))}else S(0),_(0),D(0)}catch(i){console.error("Error fetching Aptos pool/user data:",i),G(i.message||"Failed to fetch or process Aptos staking data")}finally{T(!1),B(!1)}},[s]);ve(()=>{let A=!1;a!==V.current&&(console.log("Refresh triggered by 'refreshTrigger' prop change."),A=!0,V.current=a),F(A)},[s,a,F]);const ce=()=>{F(!0)},de=x?new Date(x*1e3).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",ue=Math.floor(Date.now()/1e3),j=x?x-ue:-1,me=x?Oe(j):"N/A";if(E&&!I&&!o)return t("div",{className:"w-full text-center py-8",children:[e(Pe,{size:36,className:"text-purple-400 animate-spin mx-auto mb-4"}),e("p",{className:"text-gray-400 text-lg",children:"Loading Aptos Validator Info..."})]});if(M)return t("div",{className:"w-full text-center py-8",children:[e(Re,{size:36,className:"text-red-400 mx-auto mb-4"}),t("p",{className:"text-red-400 text-lg",children:["Error: ",M]}),e("p",{className:"text-sm text-gray-500 mt-2",children:"Could not load Aptos staking data. Please try again later."})]});if(!o&&!E)return t("div",{className:"w-full text-center py-8",children:[e(oe,{size:36,className:"text-yellow-400 mx-auto mb-4"}),e("p",{className:"text-gray-500 text-lg",children:"Aptos validator pool information is currently unavailable."})]});const pe=o&&t(Y,{children:[e("p",{className:"font-semibold mb-1 text-sm",children:"Reward Calculation:"}),C&&e("p",{children:t("strong",{children:["Est. Net APY: ",C,"%"]})}),o?.commission&&t("p",{className:"text-xs",children:["(after ",o.commission.toFixed(2),"% commission, compounded)"]}),e("hr",{className:"my-1.5 border-gray-600"}),z&&t("p",{className:"text-xs",children:["Est. Gross APY: ",z,"%"]}),P&&t("p",{className:"text-xs",children:["Est. Net APR: ",P,"% (simple)"]}),n&&t("p",{className:"text-xs",children:["Est. Gross APR: ",n,"% (simple)"]}),e("p",{className:"text-xs mt-1.5 italic",children:"APY includes compounding. APR is simple interest. All figures are estimates and may vary."})]});return t("div",{className:"w-full text-gray-200",children:[t("div",{className:"flex justify-between items-center mb-6",children:[e("h2",{className:"text-2xl font-bold text-gray-100",children:"Validator Pool Details"}),e("button",{onClick:ce,disabled:I||E,className:"p-1.5 text-purple-400 hover:text-purple-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 rounded-md hover:bg-purple-500/10",title:"Refresh pool data",children:I?e(ke,{size:20,className:"animate-spin"}):e(we,{size:20})})]}),o&&t(Y,{children:[t("div",{className:"space-y-3 mb-6",children:[e(f,{icon:Ce,label:"Validator Pool Address",value:`${o.poolAddress.substring(0,8)}...${o.poolAddress.substring(o.poolAddress.length-6)}`,valueClasses:"text-purple-300",link:`https://explorer.aptoslabs.com/validator/${k}?network=mainnet`}),e(f,{icon:Se,label:"Total APT Delegated to Pool",value:`${o.delegated.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})} APT`}),e(f,{icon:_e,label:"Validator Commission Rate",value:`${o.commission.toFixed(2)} %`}),e(f,{icon:De,label:"Est. Net Yield",value:`${C??"N/A"}% APY`,valueClasses:"font-bold text-xl text-green-400",tooltipContent:pe}),e(f,{icon:Ee,label:"Pool Lockup Period Ends",value:de,valueClasses:"text-gray-300",subValue:x&&j>0?me:x?"(Unlocked - Ready for unstake/withdraw)":null})]}),s&&t(Y,{children:[e("hr",{className:"my-6 border-t border-gray-700/60"}),e("h3",{className:"text-xl font-semibold mb-4 text-center text-gray-100",children:"Your Current Aptos (APT) Stake with aptcore.one"}),t("div",{className:"space-y-2.5 text-sm",children:[e(f,{icon:Te,label:"Your Active APT Stake",value:`${ne.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:8})} APT`,valueClasses:"font-semibold text-green-400",iconColor:"text-green-400"}),e(f,{icon:Ie,label:"APT Pending Unstake",value:`${le.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:8})} APT`,valueClasses:"font-semibold text-zinc-400",iconColor:"text-zinc-400"}),e(f,{icon:Fe,label:"APT Ready to Withdraw",value:`${ae.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:8})} APT`,valueClasses:"font-semibold text-blue-400",iconColor:"text-blue-400"})]})]})]})]})}export{je as default};
